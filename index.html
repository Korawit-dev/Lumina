<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta charset="utf-8" />
  <title data-i18n="app_title">Lumina - Healthcare Therapy Platform</title>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root{--primary:#5D5FEF;--primary-light:#8B8DF2;--primary-dark:#4A4BC7;--secondary:#FF6B8B;--secondary-light:#FF9EB4;--accent:#00D4AA;--accent-light:#4DE3C2;--success:#10B981;--warning:#F59E0B;--error:#EF4444;--light:#F8FAFC;--light-gray:#F1F5F9;--gray:#64748B;--dark:#1E293B;--white:#FFFFFF;--sidebar-width:280px;--border-radius:16px;--border-radius-sm:8px;--border-radius-lg:24px;--shadow:0 4px 20px rgba(0,0,0,0.08);--shadow-md:0 8px 30px rgba(0,0,0,0.12);--shadow-lg:0 20px 50px rgba(0,0,0,0.15);--transition:all 0.3s cubic-bezier(0.4,0,0.2,1);--transition-fast:all 0.15s ease}
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Prompt',sans-serif}
    body{background:linear-gradient(135deg,#F8FAFC 0%,#F1F5F9 100%);color:var(--dark);display:flex;min-height:100vh;overflow-x:hidden}
    .app-container{display:flex;width:100%;min-height:100vh}
    .sidebar{width:var(--sidebar-width);background:linear-gradient(180deg,var(--primary)0%,var(--primary-dark)100%);color:var(--white);display:flex;flex-direction:column;padding:2rem 1.5rem;box-shadow:var(--shadow-lg);z-index:100;position:fixed;height:100vh;overflow-y:auto;transition:var(--transition)}
    .sidebar-header{display:flex;align-items:center;margin-bottom:3rem;padding-bottom:1.5rem;border-bottom:1px solid rgba(255,255,255,0.15)}
    .sidebar-header h1{font-size:1.75rem;font-weight:700;letter-spacing:-0.5px;background:linear-gradient(90deg,#FFFFFF 0%,#E2E8F0 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    .sidebar-menu{flex:1;display:flex;flex-direction:column;gap:0.5rem}
    .menu-item{display:flex;align-items:center;padding:1rem 1.25rem;border-radius:var(--border-radius);color:rgba(255,255,255,0.85);text-decoration:none;transition:var(--transition);cursor:pointer;position:relative;overflow:hidden}
    .menu-item::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.1),transparent);transition:left 0.7s ease}
    .menu-item:hover::before{left:100%}
    .menu-item:hover{background:rgba(255,255,255,0.08);color:var(--white);transform:translateX(5px)}
    .menu-item.active{background:rgba(255,255,255,0.15);color:var(--white);box-shadow:0 4px 12px rgba(0,0,0,0.1)}
    .menu-item i{margin-right:12px;font-size:1.2rem;width:24px;text-align:center}
    .menu-item span{font-weight:500}
    .lang-toggle{background:rgba(255,255,255,0.1);border:none;color:var(--white);padding:0.5rem 1rem;border-radius:var(--border-radius-sm);cursor:pointer;transition:var(--transition);margin-top:1rem}
    .lang-toggle:hover{background:rgba(255,255,255,0.2)}
    .main-content{flex:1;padding:2.5rem;margin-left:var(--sidebar-width);transition:var(--transition);width:calc(100% - var(--sidebar-width))}
    .page{display:none;animation:fadeInUp 0.5s ease}
    .page.active{display:block}
    @keyframes fadeInUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
    .page-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:2.5rem}
    .page-header h2{font-size:2rem;font-weight:700;color:var(--dark);letter-spacing:-0.5px}
    .welcome-banner{background:linear-gradient(135deg,var(--primary)0%,var(--accent)100%);border-radius:var(--border-radius-lg);padding:3rem;color:var(--white);margin-bottom:2.5rem;box-shadow:var(--shadow-lg);position:relative;overflow:hidden}
    .welcome-banner::before{content:'';position:absolute;top:-50%;right:-20%;width:400px;height:400px;background:rgba(255,255,255,0.1);border-radius:50%}
    .welcome-content h1{font-size:2.5rem;margin-bottom:0.75rem;font-weight:700;letter-spacing:-0.5px}
    .welcome-content p{opacity:0.9;margin-bottom:2rem;font-size:1.1rem;max-width:600px}
    .cta-button{background:var(--white);color:var(--primary);border:none;padding:1rem 2rem;border-radius:50px;font-weight:600;cursor:pointer;transition:var(--transition);box-shadow:0 4px 15px rgba(0,0,0,0.1);font-size:1rem;display:inline-flex;align-items:center;gap:0.5rem}
    .cta-button:hover{transform:translateY(-3px);box-shadow:0 8px 25px rgba(0,0,0,0.15)}
    .stats-cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:1.75rem;margin-bottom:2.5rem}
    .stat-card{background:var(--white);border-radius:var(--border-radius);padding:2rem 1.5rem;display:flex;align-items:center;box-shadow:var(--shadow);transition:var(--transition);border:1px solid rgba(0,0,0,0.03);position:relative;overflow:hidden}
    .stat-card::before{content:'';position:absolute;top:0;left:0;width:100%;height:4px;background:linear-gradient(90deg,var(--primary),var(--accent))}
    .stat-card:hover{transform:translateY(-5px);box-shadow:var(--shadow-md)}
    .stat-icon{width:70px;height:70px;border-radius:var(--border-radius);display:flex;align-items:center;justify-content:center;margin-right:1.5rem;font-size:1.75rem;background:rgba(67,97,238,0.1);color:var(--primary)}
    .stat-icon.green{background:rgba(16,185,129,0.1);color:var(--success)}
    .stat-icon.blue{background:rgba(59,130,246,0.1);color:#3B82F6}
    .stat-icon.purple{background:rgba(139,92,246,0.1);color:#8B5CF6}
    .stat-info h3{font-size:2.25rem;font-weight:700;margin-bottom:0.25rem;color:var(--dark)}
    .stat-info p{color:var(--gray);font-size:0.95rem}
    .content-section{background:var(--white);border-radius:var(--border-radius);padding:2rem;margin-bottom:2rem;box-shadow:var(--shadow);border:1px solid rgba(0,0,0,0.03)}
    .content-section h3{font-size:1.5rem;font-weight:600;margin-bottom:1.5rem;color:var(--dark)}
    .usage-guide{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1.5rem}
    .guide-step{display:flex;align-items:flex-start;gap:1.25rem;padding:1.5rem;background:var(--light-gray);border-radius:var(--border-radius);transition:var(--transition)}
    .guide-step:hover{transform:translateY(-3px);box-shadow:var(--shadow)}
    .step-number{width:44px;height:44px;border-radius:50%;background:linear-gradient(135deg,var(--primary)0%,var(--accent)100%);color:var(--white);display:flex;align-items:center;justify-content:center;font-weight:bold;flex-shrink:0;font-size:1.2rem;box-shadow:0 4px 10px rgba(93,95,239,0.3)}
    .step-content h4{margin-bottom:0.5rem;color:var(--dark);font-size:1.1rem}
    .step-content p{color:var(--gray);line-height:1.6}
    .games-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:2rem}
    .game-card{background:var(--white);border-radius:var(--border-radius);overflow:hidden;box-shadow:var(--shadow);transition:var(--transition);border:1px solid rgba(0,0,0,0.03)}
    .game-card:hover{transform:translateY(-8px);box-shadow:var(--shadow-lg)}
    .game-thumbnail{position:relative;height:200px;overflow:hidden;background:linear-gradient(135deg,var(--primary)0%,var(--accent)100%)}
    .game-overlay{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;opacity:0;transition:var(--transition)}
    .game-card:hover .game-overlay{opacity:1}
    .play-btn{background:var(--white);color:var(--primary);border:none;padding:0.9rem 1.75rem;border-radius:50px;font-weight:600;cursor:pointer;transition:var(--transition);display:flex;align-items:center;gap:0.5rem;font-size:1rem}
    .play-btn:hover{background:var(--primary);color:var(--white);transform:scale(1.05)}
    .game-info{padding:1.75rem}
    .game-info h3{font-size:1.3rem;margin-bottom:0.75rem;font-weight:600;color:var(--dark)}
    .game-info p{color:var(--gray);font-size:0.95rem;margin-bottom:1.25rem;line-height:1.5}
    .game-meta{display:flex;justify-content:space-between}
    .game-type,.game-players{font-size:0.85rem;color:var(--gray);display:flex;align-items:center}
    .game-type i,.game-players i{margin-right:0.4rem;color:var(--primary)}
    .game-container{display:flex;gap:1rem;height:auto}
    #gameContainer{position:relative;width:600px;height:600px;padding:15px;border-radius:var(--border-radius-lg);overflow:hidden;background:linear-gradient(135deg,#2a2c50,#262947);box-shadow:var(--shadow-lg);display:flex;justify-content:center;align-items:center}
    #video{position:absolute;width:100%;height:100%;object-fit:cover;transform:scaleX(-1);opacity:0.2;display:block;border-radius:var(--border-radius)}
    #overlay{position:absolute;top:0;left:0;width:100%;height:100%;z-index:1}
    #board{position:relative;aspect-ratio:1/1;width:100%;height:100%;display:grid;grid-template-columns:repeat(3,1fr);grid-template-rows:repeat(3,1fr);gap:10px;z-index:2}
    .cell{aspect-ratio:1/1;background:rgba(255,255,255,0.05);border-radius:12px;display:flex;justify-content:center;align-items:center;font-size:5rem;font-weight:bold;color:var(--white);cursor:pointer;transition:var(--transition);backdrop-filter:blur(5px);border:1px solid rgba(255,255,255,0.1)}
    .cell:hover{background:rgba(255,255,255,0.1);transform:scale(1.02)}
    .cell.x-mark{color:#FF6B8B;text-shadow:0 0 10px rgba(255,107,139,0.5)}
    .cell.o-mark{color:#4DE3C2;text-shadow:0 0 10px rgba(77,227,194,0.5)}
    #cursorSim{position:absolute;width:28px;height:28px;border-radius:50%;background:rgba(77,227,194,0.9);pointer-events:none;transform:translate(50%,50%);box-shadow:0 0 20px rgba(77,227,194,0.7);z-index:3;transition:var(--transition-fast)}
    #gameStatus{margin:1.5rem 0;font-weight:600;font-size:1.2rem;text-align:center;color:var(--primary);background:var(--white);padding:1rem 2rem;border-radius:50px;box-shadow:var(--shadow);border:1px solid rgba(93,95,239,0.2)}
    .game-controls{width:auto;height:600px;background:var(--white);border-radius:var(--border-radius);padding:2rem;box-shadow:var(--shadow);overflow-y:auto;border:1px solid rgba(0,0,0,0.03)}
    .control-section{margin-bottom:2rem;padding-bottom:2rem;border-bottom:1px solid var(--light-gray)}
    .control-section:last-child{margin-bottom:0;padding-bottom:0;border-bottom:none}
    .control-section h3{font-size:1.2rem;font-weight:600;margin-bottom:1.25rem;color:var(--dark);display:flex;align-items:center;gap:0.5rem}
    .control-section h3 i{color:var(--primary)}
    .control-section button{width:100%;padding:1rem;border-radius:var(--border-radius-sm);border:1px solid var(--light-gray);background:var(--white);color:var(--dark);font-weight:500;cursor:pointer;transition:var(--transition);margin-bottom:0.8rem;display:flex;align-items:center;justify-content:center;gap:0.75rem;font-size:1rem}
    .control-section button:hover{background:var(--primary);color:var(--white);border-color:var(--primary);transform:translateY(-2px)}
    .control-section button.recording{background:var(--secondary);color:var(--white);border-color:var(--secondary)}
    .slider-control{margin-bottom:1.5rem}
    .slider-control label{display:block;margin-bottom:0.75rem;font-size:0.95rem;color:var(--gray);font-weight:500}
    .slider-control input{width:100%;height:6px;border-radius:3px;background:var(--light-gray);outline:none;-webkit-appearance:none}
    .slider-control input::-webkit-slider-thumb{-webkit-appearance:none;width:20px;height:20px;border-radius:50%;background:var(--primary);cursor:pointer;box-shadow:0 2px 6px rgba(93,95,239,0.4)}
    .control-section select{width:100%;padding:1rem;border-radius:var(--border-radius-sm);border:1px solid var(--light-gray);background:var(--white);color:var(--dark);font-size:1rem;cursor:pointer;transition:var(--transition)}
    .control-section select:focus{border-color:var(--primary);box-shadow:0 0 0 3px rgba(93,95,239,0.1)}
    .session-stats{display:grid;grid-template-columns:repeat(2,1fr);gap:1rem}
    .stat{text-align:center;padding:1.5rem 1rem;background:var(--light-gray);border-radius:var(--border-radius-sm);transition:var(--transition)}
    .stat:hover{transform:translateY(-3px);box-shadow:var(--shadow)}
    .stat-value{display:block;font-size:2rem;font-weight:700;color:var(--primary);margin-bottom:0.5rem}
    .stat-label{font-size:0.9rem;color:var(--gray)}
    .replay-list{display:flex;flex-direction:column;gap:1.5rem}
    .replay-item{background:var(--white);border-radius:var(--border-radius);padding:2rem;box-shadow:var(--shadow);border-left:5px solid var(--primary);transition:var(--transition)}
    .replay-item:hover{transform:translateY(-5px);box-shadow:var(--shadow-md)}
    .replay-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1.25rem}
    .replay-header h4{font-size:1.3rem;font-weight:600;color:var(--dark)}
    .replay-date{color:var(--gray);font-size:0.9rem;background:var(--light-gray);padding:0.4rem 0.8rem;border-radius:50px}
    .replay-details{margin-bottom:1.5rem;display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:1rem}
    .replay-details p{margin-bottom:0.5rem;color:var(--gray);display:flex;align-items:center;gap:0.5rem}
    .replay-details p i{color:var(--primary);width:16px}
    .replay-actions{display:flex;gap:1rem}
    .btn-danger{background:#EF4444;color:white;padding:0.75rem 1.5rem;border-radius:var(--border-radius-sm);font-weight:500;cursor:pointer;transition:var(--transition);display:flex;align-items:center;gap:0.5rem;font-size:0.95rem;border:none}
    .btn-danger:hover{background:#DC2626;transform:translateY(-2px)}
    .replay-canvas{position:absolute;top:0;left:0;width:100%;height:100%;z-index:2;pointer-events:none}
    .btn-primary,.btn-secondary{max-width:200px;padding:0.75rem 1.5rem;border-radius:var(--border-radius-sm);font-weight:500;cursor:pointer;transition:var(--transition);display:flex;align-items:center;gap:0.5rem;font-size:0.95rem;border:none}
    .btn-primary{background:var(--primary);color:var(--white)}
    .btn-secondary{background:var(--light-gray);color:var(--dark)}
    .btn-primary:hover{background:var(--primary-dark);transform:translateY(-2px)}
    .btn-secondary:hover{background:var(--gray);color:var(--white);transform:translateY(-2px)}
    .empty-state{text-align:center;padding:4rem 2rem;color:var(--gray)}
    .empty-state i{margin-bottom:1.5rem;color:var(--light-gray);opacity:0.5}
    .empty-state p{font-size:1.1rem}
    .settings-form{display:flex;flex-direction:column;gap:2rem}
    .checkbox-control{display:flex;align-items:center;gap:1rem;padding:1rem;background:var(--light-gray);border-radius:var(--border-radius-sm);transition:var(--transition)}
    .checkbox-control:hover{background:rgba(93,95,239,0.05)}
    .checkbox-control input{width:20px;height:20px;accent-color:var(--primary)}
    .checkbox-control label{font-weight:500;color:var(--dark)}
    .system-info{display:flex;flex-direction:column;gap:1.5rem}
    .system-info p{padding:1rem 0;border-bottom:1px solid var(--light-gray);display:flex;justify-content:space-between}
    .system-info p span{font-weight:600;color:var(--primary)}
    @media (max-width:768px){.sidebar{width:100%;height:auto;position:fixed;bottom:0;top:auto;padding:0.75rem 1rem;z-index:1000}.sidebar-header{display:none}.sidebar-menu{flex-direction:row;justify-content:space-around;gap:0}.menu-item{flex-direction:column;padding:0.5rem;border-radius:12px;font-size:0.8rem;text-align:center;min-width:60px}.menu-item i{margin-right:0;margin-bottom:0.25rem;font-size:1.2rem}.menu-item span{font-size:0.75rem}.main-content{margin-left:0;width:100%;padding:1rem;margin-bottom:80px}.page-header{flex-direction:column;align-items:flex-start;gap:1rem}.welcome-banner{padding:1.5rem;margin-bottom:1.5rem}.welcome-content h1{font-size:1.75rem}.stats-cards{grid-template-columns:1fr;gap:1rem;margin-bottom:1.5rem}.stat-card{padding:1.5rem 1rem}.stat-icon{width:50px;height:50px;margin-right:1rem;font-size:1.5rem}.content-section{padding:1.5rem;margin-bottom:1.5rem}.usage-guide{grid-template-columns:1fr;gap:1rem}.guide-step{padding:1rem}.step-number{width:36px;height:36px;font-size:1rem}.games-grid{grid-template-columns:1fr;gap:1.5rem}.game-thumbnail{height:160px}.game-info{padding:1.25rem}.game-container{flex-direction:column}#gameContainer{width:100%;height:auto;aspect-ratio:1/1;padding:10px}.cell{font-size:3rem}.game-controls{width:100%;height:auto;padding:1.5rem}.control-section{margin-bottom:1.5rem;padding-bottom:1.5rem}.session-stats{grid-template-columns:1fr;gap:0.75rem}.stat{padding:1rem 0.5rem}.replay-item{padding:1.5rem}.replay-header{flex-direction:column;align-items:flex-start;gap:0.5rem}.replay-details{grid-template-columns:1fr;gap:0.5rem}.replay-actions{flex-direction:column;gap:0.5rem}.btn-primary,.btn-secondary,.btn-danger{width:100%;justify-content:center}.settings-form{gap:1.5rem}.checkbox-control{padding:0.75rem}}
  </style>
</head>

<body>
  <div class="app-container">
    <!-- Navigation Sidebar -->
    <nav class="sidebar">
      <div class="sidebar-header">
        <h1>Lumina</h1>
      </div>

      <div class="sidebar-menu">
        <a class="menu-item active" data-page="home" onclick="changePage('home')">
          <i class="fas fa-home"></i>
          <span data-i18n="nav_home">Home</span>
        </a>
        <a class="menu-item" data-page="aboutme" onclick="changePage('aboutme')">
          <i class="fa fa-lightbulb"></i>
          <span data-i18n="nav_about">About Us</span>
        </a>
        <a class="menu-item" data-page="games" onclick="changePage('games')">
          <i class="fas fa-gamepad"></i>
          <span data-i18n="nav_games">Therapy Games</span>
        </a>
        <a class="menu-item" data-page="replay" onclick="changePage('replay')">
          <i class="fas fa-history"></i>
          <span data-i18n="nav_history">Play History</span>
        </a>
        <a class="menu-item" data-page="settings" onclick="changePage('settings')">
          <i class="fas fa-cog"></i>
          <span data-i18n="nav_settings">Settings</span>
        </a>
      </div>
      
      <button class="lang-toggle" onclick="toggleLanguage()">
        <i class="fas fa-language"></i> <span id="lang-text">EN</span>
      </button>
    </nav>

    <!-- Main Content Area -->
    <main class="main-content">
      <!-- Home Page -->
      <section id="home" class="page active">
        <div class="page-header">
          <h2 data-i18n="home_title">Main Dashboard</h2>
        </div>

        <div class="welcome-banner">
          <div class="welcome-content">
            <h1 data-i18n="welcome_title">Welcome to Lumina</h1>
            <p data-i18n="welcome_desc">Therapeutic gaming platform for hand and arm movement recovery using cutting-edge technology</p>
            <button class="cta-button" onclick="changePage('games')">
              <i class="fas fa-play-circle"></i> <span data-i18n="start_playing">Start Playing</span>
            </button>
          </div>
        </div>

        <div class="stats-cards">
          <div class="stat-card">
            <div class="stat-icon green">
              <i class="fas fa-gamepad"></i>
            </div>
            <div class="stat-info">
              <h3>5</h3>
              <p data-i18n="therapy_games">Therapy Games</p>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-icon blue">
              <i class="fas fa-clock"></i>
            </div>
            <div class="stat-info">
              <h3 id="totalPlayTime">0</h3>
              <p data-i18n="minutes_played">Minutes Played</p>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-icon purple">
              <i class="fas fa-chart-line"></i>
            </div>
            <div class="stat-info">
              <h3 id="sessionCount">0</h3>
              <p data-i18n="sessions_recorded">Sessions Recorded</p>
            </div>
          </div>
        </div>

        <div class="content-section">
          <h3 data-i18n="usage_guide">Usage Guide</h3>
          <div class="usage-guide">
            <div class="guide-step">
              <div class="step-number">1</div>
              <div class="step-content">
                <h4 data-i18n="step1_title">Select Therapy Game</h4>
                <p data-i18n="step1_desc">Go to "Therapy Games" and select an appropriate game</p>
              </div>
            </div>
            <div class="guide-step">
              <div class="step-number">2</div>
              <div class="step-content">
                <h4 data-i18n="step2_title">Camera Setup</h4>
                <p data-i18n="step2_desc">Turn on camera and adjust position to see both hands clearly</p>
              </div>
            </div>
            <div class="guide-step">
              <div class="step-number">3</div>
              <div class="step-content">
                <h4 data-i18n="step3_title">Start Recording</h4>
                <p data-i18n="step3_desc">Press "Start Recording" to record movement data during gameplay</p>
              </div>
            </div>
            <div class="guide-step">
              <div class="step-number">4</div>
              <div class="step-content">
                <h4 data-i18n="step4_title">Export Data</h4>
                <p data-i18n="step4_desc">After playing, export JSON file for therapist analysis</p>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- About me -->
      <section id="aboutme" class="page">
        <div class="page-header">
          <h2 data-i18n="about_title">About Us</h2>
        </div>

        <div class="content-section">
          <h3 data-i18n="about_lumina">About Lumina</h3>
          <div class="about-content">
            <p data-i18n="about_desc">Lumina is a therapeutic gaming platform developed for hand and arm movement recovery using Computer Vision via MediaPipe Hands</p>

            <h4 data-i18n="features_title">Key Features</h4>
            <ul>
              <li data-i18n="feature1">Real-time hand movement tracking</li>
              <li data-i18n="feature2">Therapy games specifically designed for rehabilitation</li>
              <li data-i18n="feature3">Record and analyze therapy data</li>
              <li data-i18n="feature4">Replay system for progress tracking</li>
            </ul>
          </div>
        </div>
      </section>

      <!-- Games Page -->
      <section id="games" class="page">
        <div class="page-header">
          <h2 data-i18n="games_title">Therapy Games</h2>
        </div>

        <div class="games-grid">
          <div class="game-card" data-game="tictactoe">
            <div class="game-thumbnail">
              <div class="game-overlay">
                <button class="play-btn" onclick="changePage('tictactoe')">
                  <i class="fas fa-play"></i> <span data-i18n="play_game">Play Game</span>
                </button>
              </div>
            </div>
            <div class="game-info">
              <h3>Tic Tac Toe</h3>
              <p data-i18n="tictactoe_desc">Classic XO game for brain training and hand control by alternating symbol placement</p>
              <div class="game-meta">
                <span class="game-type"><i class="fas fa-chess-board"></i> <span data-i18n="board_game">Board Game</span></span>
                <span class="game-players"><i class="fas fa-users"></i> <span data-i18n="players_1_2">1-2 Players</span></span>
              </div>
            </div>
          </div>

          <div class="game-card">
            <div class="game-thumbnail">
              <div class="game-overlay">
                <button class="play-btn" onclick="alert(getText('game_development'))">
                  <i class="fas fa-play"></i> <span data-i18n="play_game">Play Game</span>
                </button>
              </div>
            </div>
            <div class="game-info">
              <h3 data-i18n="memory_game">Memory Game</h3>
              <p data-i18n="memory_desc">Train your brain by matching hidden images to develop memory and recognition</p>
              <div class="game-meta">
                <span class="game-type"><i class="fas fa-puzzle-piece"></i> <span data-i18n="puzzle_game">Puzzle Game</span></span>
                <span class="game-players"><i class="fas fa-user"></i> <span data-i18n="player_1">1 Player</span></span>
              </div>
            </div>
          </div>

          <div class="game-card">
            <div class="game-thumbnail">
              <div class="game-overlay">
                <button class="play-btn" onclick="alert(getText('game_development'))">
                  <i class="fas fa-play"></i> <span data-i18n="play_game">Play Game</span>
                </button>
              </div>
            </div>
            <div class="game-info">
              <h3 data-i18n="reaction_game">Reaction Game</h3>
              <p data-i18n="reaction_desc">Develop agility and response with games requiring quick reactions</p>
              <div class="game-meta">
                <span class="game-type"><i class="fas fa-bolt"></i> <span data-i18n="speed_game">Speed Game</span></span>
                <span class="game-players"><i class="fas fa-user"></i> <span data-i18n="player_1">1 Player</span></span>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Tic Tac Toe Game Page -->
      <section id="tictactoe" class="page">
        <div class="game-container">
          <div id="gameContainer">
            <video id="video" autoplay playsinline muted></video>
            <canvas id="overlay"></canvas>
            <div id="board">
              <div class="cell" data-index="0"></div>
              <div class="cell" data-index="1"></div>
              <div class="cell" data-index="2"></div>
              <div class="cell" data-index="3"></div>
              <div class="cell" data-index="4"></div>
              <div class="cell" data-index="5"></div>
              <div class="cell" data-index="6"></div>
              <div class="cell" data-index="7"></div>
              <div class="cell" data-index="8"></div>
            </div>
            <div id="cursorSim" style="display: none;"></div>
          </div>

          <div class="game-controls">
            <div class="control-section">
              <h2>Tic Tac Toe</h2>
              <div class="game-actions flex justify-between mb-2" style="gap: 10px;">
                <button class="action-btn" id="resetBtn" onclick="restartGame()">
                  <i class="fas fa-redo"></i> <span data-i18n="restart">Restart</span>
                </button>
                <button class="action-btn" onclick="changePage('games')">
                  <i class="fas fa-arrow-left"></i> <span data-i18n="back">Back</span>
                </button>
              </div>
              <div id="gameStatus" data-i18n="player_x_turn">Player X's turn</div>
              <div id="connectionStatus"></div>

              <h3><i class="fas fa-gamepad"></i> <span data-i18n="game_controls">Game Controls</span></h3>
              <button id="toggleBtn" onclick="toggleVideo()">
                <i class="fas fa-video"></i> <span id="camera-text" data-i18n="camera_on">Turn On Camera</span>
              </button>
              <div class="slider-control">
                <label data-i18n="control_smoothness">Control Smoothness:</label>
                <input type="range" id="smoothRange" min="0" max="0.9" step="0.05" value="0.5">
              </div>
            </div>

            <div class="control-section">
              <h3><i class="fas fa-users"></i> <span data-i18n="game_mode">Game Mode</span></h3>
              <select id="gameMode">
                <option value="single" data-i18n="single_player">Single Player (vs Computer)</option>
                <option value="local" data-i18n="two_players">Two Players (Local)</option>
              </select>
            </div>

            <div class="control-section">
              <h3><i class="fas fa-record-vinyl"></i> <span data-i18n="record_session">Record Session</span></h3>
              <button id="recordBtn" onclick="toggleRecording()">
                <i class="fas fa-record-vinyl"></i> <span id="recordText" data-i18n="start_recording">Start Recording</span>
              </button>
              <p id="recordingStatus" data-i18n="press_to_record">Press to start recording movement data</p>
              <button id="exportBtn" onclick="exportSession()" style="display: none;">
                <i class="fas fa-download"></i> <span data-i18n="export_data">Export Data</span>
              </button>
            </div>

            <div class="control-section">
              <h3><i class="fas fa-chart-bar"></i> <span data-i18n="session_stats">Session Stats</span></h3>
              <div class="session-stats">
                <div class="stat">
                  <span class="stat-value" id="moveCount">0</span>
                  <span class="stat-label" data-i18n="movements">Movements</span>
                </div>
                <div class="stat">
                  <span class="stat-value" id="sessionTime">0s</span>
                  <span class="stat-label" data-i18n="duration">Duration</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Replay Page -->
      <section id="replay" class="page">
        <div class="page-header">
          <h2 data-i18n="play_history">Play History</h2>
          <button class="cta-button" onclick="clearAllSessions()">
            <i class="fas fa-trash"></i> <span data-i18n="clear_all">Clear All</span>
          </button>
        </div>

        <div class="content-section">
          <h3 data-i18n="saved_sessions">Saved Sessions</h3>
          <div class="replay-list" id="replayList">
            <div class="empty-state">
              <i class="fas fa-history fa-3x"></i>
              <p data-i18n="no_history">No play history yet</p>
            </div>
          </div>
        </div>
      </section>

      <!-- Settings Page -->
      <section id="settings" class="page">
        <div class="page-header">
          <h2 data-i18n="settings_title">Settings</h2>
        </div>

        <div class="content-section">
          <h3 data-i18n="mediapipe_settings">MediaPipe Hands Settings</h3>
          <div class="settings-form">
            <div class="slider-control">
              <label for="minDetectionConfidence" data-i18n="min_detection_confidence">Minimum Detection Confidence:</label>
              <input type="range" id="minDetectionConfidence" min="0" max="1" step="0.05" value="0.7">
              <span id="minDetectionConfidenceValue">0.7</span>
            </div>
            <div class="slider-control">
              <label for="minTrackingConfidence" data-i18n="min_tracking_confidence">Minimum Tracking Confidence:</label>
              <input type="range" id="minTrackingConfidence" min="0" max="1" step="0.05" value="0.7">
              <span id="minTrackingConfidenceValue">0.7</span>
            </div>
            <div style="display: flex; justify-content: space-around;">
              <div class="slider-control" style="flex: 1; justify-items: center;">
                <label for="modelComplexity" data-i18n="model_complexity">Model Complexity:</label>
                <select id="modelComplexity">
                  <option value="0" data-i18n="low">Low</option>
                  <option value="1" selected data-i18n="medium">Medium</option>
                  <option value="2" data-i18n="high">High</option>
                </select>
              </div>
              <div class="slider-control" style="flex: 1; justify-items: center;">
                <label for="maxNumHands" data-i18n="max_hands">Maximum Hands:</label>
                <select id="maxNumHands">
                  <option value="1" data-i18n="one_hand">1 Hand</option>
                  <option value="2" data-i18n="two_hands">2 Hands</option>
                </select>
              </div>
            </div>
            <button id="saveSettings" class="btn-primary" onclick="saveMediaPipeSettings()">
              <i class="fas fa-save"></i> <span data-i18n="save_settings">Save Settings</span>
            </button>
          </div>
        </div>

        <div class="content-section">
          <h3 data-i18n="data_recording_settings">Data Recording Settings</h3>
          <div class="settings-form">
            <div class="checkbox-control">
              <input type="checkbox" id="autoRecord" checked>
              <label for="autoRecord" data-i18n="auto_record_prompt">Prompt to record when starting game</label>
            </div>
            <div class="checkbox-control">
              <input type="checkbox" id="recordHandData" checked>
              <label for="recordHandData" data-i18n="record_hand_data">Record hand movement data</label>
            </div>
            <div class="checkbox-control">
              <input type="checkbox" id="recordGameData" checked>
              <label for="recordGameData" data-i18n="record_game_data">Record game state data</label>
            </div>
          </div>
        </div>

        <div class="content-section">
          <h3 data-i18n="system_info">System Info</h3>
          <div class="system-info">
            <p data-i18n="app_version">App Version: <span>1.0.0</span></p>
            <p data-i18n="mediapipe_status">MediaPipe Hands: <span>Available</span></p>
            <p data-i18n="connection_status">Connection: <span>Offline</span></p>
            <button class="btn-secondary" onclick="resetAppSettings()">
              <i class="fas fa-refresh"></i> <span data-i18n="reset_settings">Reset Settings</span>
            </button>
          </div>
        </div>
      </section>
    </main>
  </div>
  
  <script>
    // Global Variables
    let controller, gameOX;
    let isRecording = false;
    let recordingSessionId = null;
    let recordedData = [];
    let sessionStartTime = null;
    let cameraOn = false;
    let recordingInterval;
    let replayCanvas = null;

    // Language System
    const translations = {
      en: {
        app_title: "Lumina - Healthcare Therapy Platform",
        nav_home: "Home", nav_about: "About Us", nav_games: "Therapy Games",
        nav_history: "Play History", nav_settings: "Settings",
        home_title: "Main Dashboard", welcome_title: "Welcome to Lumina",
        welcome_desc: "Therapeutic gaming platform for hand and arm movement recovery using cutting-edge technology",
        start_playing: "Start Playing", therapy_games: "Therapy Games",
        minutes_played: "Minutes Played", sessions_recorded: "Sessions Recorded",
        usage_guide: "Usage Guide", step1_title: "Select Therapy Game",
        step1_desc: "Go to \"Therapy Games\" and select an appropriate game",
        step2_title: "Camera Setup", step2_desc: "Turn on camera and adjust position to see both hands clearly",
        step3_title: "Start Recording", step3_desc: "Press \"Start Recording\" to record movement data during gameplay",
        step4_title: "Export Data", step4_desc: "After playing, export JSON file for therapist analysis",
        about_title: "About Us", about_lumina: "About Lumina",
        about_desc: "Lumina is a therapeutic gaming platform developed for hand and arm movement recovery using Computer Vision via MediaPipe Hands",
        features_title: "Key Features", feature1: "Real-time hand movement tracking",
        feature2: "Therapy games specifically designed for rehabilitation",
        feature3: "Record and analyze therapy data", feature4: "Replay system for progress tracking",
        games_title: "Therapy Games", play_game: "Play Game", board_game: "Board Game",
        players_1_2: "1-2 Players", puzzle_game: "Puzzle Game", player_1: "1 Player",
        speed_game: "Speed Game", memory_game: "Memory Game",
        memory_desc: "Train your brain by matching hidden images to develop memory and recognition",
        reaction_game: "Reaction Game",
        reaction_desc: "Develop agility and response with games requiring quick reactions",
        tictactoe_desc: "Classic XO game for brain training and hand control by alternating symbol placement",
        game_development: "This game is under development",
        restart: "Restart", back: "Back", player_x_turn: "Player X's turn",
        game_controls: "Game Controls", camera_on: "Turn On Camera", camera_off: "Turn Off Camera",
        control_smoothness: "Control Smoothness:", game_mode: "Game Mode",
        single_player: "Single Player (vs Computer)", two_players: "Two Players (Local)",
        record_session: "Record Session", start_recording: "Start Recording",
        stop_recording: "Stop Recording", press_to_record: "Press to start recording movement data",
        recording_in_progress: "Recording movement data...", recording_finished: "Recording finished",
        export_data: "Export Data", session_stats: "Session Stats", movements: "Movements",
        duration: "Duration", play_history: "Play History", clear_all: "Clear All",
        saved_sessions: "Saved Sessions", no_history: "No play history yet",
        settings_title: "Settings", mediapipe_settings: "MediaPipe Hands Settings",
        min_detection_confidence: "Minimum Detection Confidence:",
        min_tracking_confidence: "Minimum Tracking Confidence:",
        model_complexity: "Model Complexity:", max_hands: "Maximum Hands:",
        low: "Low", medium: "Medium", high: "High", one_hand: "1 Hand", two_hands: "2 Hands",
        save_settings: "Save Settings", data_recording_settings: "Data Recording Settings",
        auto_record_prompt: "Prompt to record when starting game",
        record_hand_data: "Record hand movement data", record_game_data: "Record game state data",
        system_info: "System Info", app_version: "App Version:",
        mediapipe_status: "MediaPipe Hands:", connection_status: "Connection:",
        reset_settings: "Reset Settings", player_won: "Player {player} wins! ðŸŽ‰",
        draw: "Draw! ðŸ¤", computer_turn: "Computer's turn (O)...",
        player_turn: "Player {player}'s turn", camera_error: "Cannot access camera. Please check camera permissions",
        no_sessions: "No sessions to export", export_success: "Export completed successfully",
        export_session_success: "Session exported successfully",
        confirm_delete: "Are you sure you want to delete this session?",
        delete_success: "Session deleted successfully",
        confirm_clear_all: "Are you sure you want to clear all history?",
        clear_all_success: "History cleared successfully",
        confirm_reset: "Are you sure you want to reset all settings?",
        reset_success: "Settings reset successfully", record_prompt: "Record movement data for this session?",
        settings_saved: "Settings saved successfully"
      },
      th: {
        app_title: "Lumina - à¹à¸žà¸¥à¸•à¸Ÿà¸­à¸£à¹Œà¸¡à¹€à¸à¸¡à¸šà¸³à¸šà¸±à¸”",
        nav_home: "à¸«à¸™à¹‰à¸²à¹à¸£à¸", nav_about: "à¹€à¸à¸µà¹ˆà¸¢à¸§à¸à¸±à¸šà¹€à¸£à¸²", nav_games: "à¹€à¸à¸¡à¸šà¸³à¸šà¸±à¸”",
        nav_history: "à¸›à¸£à¸°à¸§à¸±à¸•à¸´à¸à¸²à¸£à¹€à¸¥à¹ˆà¸™", nav_settings: "à¸à¸²à¸£à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸²",
        home_title: "à¹à¸”à¸Šà¸šà¸­à¸£à¹Œà¸”à¸«à¸¥à¸±à¸", welcome_title: "à¸¢à¸´à¸™à¸”à¸µà¸•à¹‰à¸­à¸™à¸£à¸±à¸šà¸ªà¸¹à¹ˆ Lumina",
        welcome_desc: "à¹à¸žà¸¥à¸•à¸Ÿà¸­à¸£à¹Œà¸¡à¹€à¸à¸¡à¸šà¸³à¸šà¸±à¸”à¸ªà¸³à¸«à¸£à¸±à¸šà¸Ÿà¸·à¹‰à¸™à¸Ÿà¸¹à¸à¸²à¸£à¹€à¸„à¸¥à¸·à¹ˆà¸­à¸™à¹„à¸«à¸§à¸¡à¸·à¸­à¹à¸¥à¸°à¹à¸‚à¸™à¸”à¹‰à¸§à¸¢à¹€à¸—à¸„à¹‚à¸™à¹‚à¸¥à¸¢à¸µà¸¥à¹‰à¸³à¸ªà¸¡à¸±à¸¢",
        start_playing: "à¹€à¸£à¸´à¹ˆà¸¡à¹€à¸¥à¹ˆà¸™à¹€à¸à¸¡", therapy_games: "à¹€à¸à¸¡à¸šà¸³à¸šà¸±à¸”",
        minutes_played: "à¸™à¸²à¸—à¸µà¸—à¸µà¹ˆà¹€à¸¥à¹ˆà¸™", sessions_recorded: "à¹€à¸‹à¸ªà¸Šà¸±à¸™à¸—à¸µà¹ˆà¸šà¸±à¸™à¸—à¸¶à¸",
        usage_guide: "à¹à¸™à¸°à¸™à¸³à¸à¸²à¸£à¹ƒà¸Šà¹‰à¸‡à¸²à¸™", step1_title: "à¹€à¸¥à¸·à¸­à¸à¹€à¸à¸¡à¸šà¸³à¸šà¸±à¸”",
        step1_desc: "à¹„à¸›à¸—à¸µà¹ˆà¸«à¸™à¹‰à¸² \"à¹€à¸à¸¡à¸šà¸³à¸šà¸±à¸”\" à¹à¸¥à¸°à¹€à¸¥à¸·à¸­à¸à¹€à¸à¸¡à¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¹€à¸¥à¹ˆà¸™à¸•à¸²à¸¡à¸„à¸§à¸²à¸¡à¹€à¸«à¸¡à¸²à¸°à¸ªà¸¡",
        step2_title: "à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸²à¸à¸¥à¹‰à¸­à¸‡", step2_desc: "à¹€à¸›à¸´à¸”à¸à¸¥à¹‰à¸­à¸‡à¹à¸¥à¸°à¸›à¸£à¸±à¸šà¸•à¸³à¹à¸«à¸™à¹ˆà¸‡à¹ƒà¸«à¹‰à¹€à¸«à¹‡à¸™à¸¡à¸·à¸­à¸—à¸±à¹‰à¸‡à¸ªà¸­à¸‡à¸‚à¹‰à¸²à¸‡à¸Šà¸±à¸”à¹€à¸ˆà¸™",
        step3_title: "à¹€à¸£à¸´à¹ˆà¸¡à¸šà¸±à¸™à¸—à¸¶à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥", step3_desc: "à¸à¸”à¸›à¸¸à¹ˆà¸¡ \"à¹€à¸£à¸´à¹ˆà¸¡à¸šà¸±à¸™à¸—à¸¶à¸\" à¹€à¸žà¸·à¹ˆà¸­à¸šà¸±à¸™à¸—à¸¶à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸à¸²à¸£à¹€à¸„à¸¥à¸·à¹ˆà¸­à¸™à¹„à¸«à¸§à¸£à¸°à¸«à¸§à¹ˆà¸²à¸‡à¹€à¸¥à¹ˆà¸™à¹€à¸à¸¡",
        step4_title: "à¸ªà¹ˆà¸‡à¸­à¸­à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥", step4_desc: "à¸«à¸¥à¸±à¸‡à¸ˆà¸²à¸à¹€à¸¥à¹ˆà¸™à¹€à¸ªà¸£à¹‡à¸ˆ à¸ªà¹ˆà¸‡à¸­à¸­à¸à¹„à¸Ÿà¸¥à¹Œ JSON à¹ƒà¸«à¹‰à¹à¸žà¸—à¸¢à¹Œà¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¸œà¸¥à¸à¸²à¸£à¸šà¸³à¸šà¸±à¸”",
        about_title: "à¹€à¸à¸µà¹ˆà¸¢à¸§à¸à¸±à¸šà¹€à¸£à¸²", about_lumina: "à¹€à¸à¸µà¹ˆà¸¢à¸§à¸à¸±à¸š Lumina",
        about_desc: "Lumina à¹€à¸›à¹‡à¸™à¹à¸žà¸¥à¸•à¸Ÿà¸­à¸£à¹Œà¸¡à¹€à¸à¸¡à¸šà¸³à¸šà¸±à¸”à¸—à¸µà¹ˆà¸žà¸±à¸’à¸™à¸²à¸‚à¸¶à¹‰à¸™à¹€à¸žà¸·à¹ˆà¸­à¸Ÿà¸·à¹‰à¸™à¸Ÿà¸¹à¸à¸²à¸£à¹€à¸„à¸¥à¸·à¹ˆà¸­à¸™à¹„à¸«à¸§à¸¡à¸·à¸­à¹à¸¥à¸°à¹à¸‚à¸™à¹‚à¸”à¸¢à¹ƒà¸Šà¹‰à¹€à¸—à¸„à¹‚à¸™à¹‚à¸¥à¸¢à¸µ Computer Vision à¸œà¹ˆà¸²à¸™ MediaPipe Hands",
        features_title: "à¸„à¸¸à¸“à¸ªà¸¡à¸šà¸±à¸•à¸´à¸«à¸¥à¸±à¸", feature1: "à¸•à¸´à¸”à¸•à¸²à¸¡à¸à¸²à¸£à¹€à¸„à¸¥à¸·à¹ˆà¸­à¸™à¹„à¸«à¸§à¸¡à¸·à¸­à¹à¸šà¸šà¹€à¸£à¸µà¸¢à¸¥à¹„à¸—à¸¡à¹Œ",
        feature2: "à¹€à¸à¸¡à¸šà¸³à¸šà¸±à¸”à¸—à¸µà¹ˆà¸­à¸­à¸à¹à¸šà¸šà¸¡à¸²à¹€à¸‰à¸žà¸²à¸°à¸ªà¸³à¸«à¸£à¸±à¸šà¸à¸²à¸£à¸Ÿà¸·à¹‰à¸™à¸Ÿà¸¹",
        feature3: "à¸šà¸±à¸™à¸—à¸¶à¸à¹à¸¥à¸°à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸à¸²à¸£à¸šà¸³à¸šà¸±à¸”", feature4: "à¸£à¸°à¸šà¸š replay à¸ªà¸³à¸«à¸£à¸±à¸šà¸•à¸´à¸”à¸•à¸²à¸¡à¸„à¸§à¸²à¸¡à¸à¹‰à¸²à¸§à¸«à¸™à¹‰à¸²",
        games_title: "à¹€à¸à¸¡à¸šà¸³à¸šà¸±à¸”", play_game: "à¹€à¸¥à¹ˆà¸™à¹€à¸à¸¡", board_game: "à¹€à¸à¸¡à¸à¸£à¸°à¸”à¸²à¸™",
        players_1_2: "1-2 à¸œà¸¹à¹‰à¹€à¸¥à¹ˆà¸™", puzzle_game: "à¹€à¸à¸¡à¸›à¸£à¸´à¸¨à¸™à¸²", player_1: "1 à¸œà¸¹à¹‰à¹€à¸¥à¹ˆà¸™",
        speed_game: "à¹€à¸à¸¡à¸„à¸§à¸²à¸¡à¹€à¸£à¹‡à¸§", memory_game: "à¹€à¸à¸¡à¸à¸¶à¸à¸„à¸§à¸²à¸¡à¸ˆà¸³",
        memory_desc: "à¸à¸¶à¸à¸ªà¸¡à¸­à¸‡à¸”à¹‰à¸§à¸¢à¸à¸²à¸£à¸ˆà¸±à¸šà¸„à¸¹à¹ˆà¸ à¸²à¸žà¸—à¸µà¹ˆà¸‹à¹ˆà¸­à¸™à¸­à¸¢à¸¹à¹ˆ à¹€à¸žà¸·à¹ˆà¸­à¸žà¸±à¸’à¸™à¸²à¸„à¸§à¸²à¸¡à¸ˆà¸³à¹à¸¥à¸°à¸à¸²à¸£à¸ˆà¸”à¸ˆà¸³",
        reaction_game: "à¹€à¸à¸¡à¸à¸¶à¸à¸›à¸à¸´à¸à¸´à¸£à¸´à¸¢à¸²",
        reaction_desc: "à¸žà¸±à¸’à¸™à¸²à¸„à¸§à¸²à¸¡à¸§à¹ˆà¸­à¸‡à¹„à¸§à¹à¸¥à¸°à¸›à¸à¸´à¸à¸´à¸£à¸´à¸¢à¸²à¸•à¸­à¸šà¸ªà¸™à¸­à¸‡à¸”à¹‰à¸§à¸¢à¹€à¸à¸¡à¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¹ƒà¸Šà¹‰à¸„à¸§à¸²à¸¡à¸£à¸§à¸”à¹€à¸£à¹‡à¸§",
        tictactoe_desc: "à¹€à¸à¸¡ XO à¸„à¸¥à¸²à¸ªà¸ªà¸´à¸à¸ªà¸³à¸«à¸£à¸±à¸šà¸à¸¶à¸à¸ªà¸¡à¸­à¸‡à¹à¸¥à¸°à¸à¸²à¸£à¸„à¸§à¸šà¸„à¸¸à¸¡à¸¡à¸·à¸­à¸”à¹‰à¸§à¸¢à¸à¸²à¸£à¸§à¸²à¸‡à¸ªà¸±à¸à¸¥à¸±à¸à¸©à¸“à¹Œà¸ªà¸¥à¸±à¸šà¸à¸±à¸™",
        game_development: "à¹€à¸à¸¡à¸™à¸µà¹‰à¸à¸³à¸¥à¸±à¸‡à¸­à¸¢à¸¹à¹ˆà¹ƒà¸™à¸‚à¸±à¹‰à¸™à¸•à¸­à¸™à¸à¸²à¸£à¸žà¸±à¸’à¸™à¸²",
        restart: "à¹€à¸£à¸´à¹ˆà¸¡à¹ƒà¸«à¸¡à¹ˆ", back: "à¸à¸¥à¸±à¸š", player_x_turn: "à¸œà¸¹à¹‰à¹€à¸¥à¹ˆà¸™ X à¹€à¸£à¸´à¹ˆà¸¡à¹€à¸¥à¹ˆà¸™",
        game_controls: "à¸à¸²à¸£à¸„à¸§à¸šà¸„à¸¸à¸¡à¹€à¸à¸¡", camera_on: "à¹€à¸›à¸´à¸”à¸à¸¥à¹‰à¸­à¸‡", camera_off: "à¸›à¸´à¸”à¸à¸¥à¹‰à¸­à¸‡",
        control_smoothness: "à¸„à¸§à¸²à¸¡à¸¥à¸·à¹ˆà¸™à¹„à¸«à¸¥à¸‚à¸­à¸‡à¸à¸²à¸£à¸„à¸§à¸šà¸„à¸¸à¸¡:", game_mode: "à¹‚à¸«à¸¡à¸”à¸à¸²à¸£à¹€à¸¥à¹ˆà¸™",
        single_player: "à¸œà¸¹à¹‰à¹€à¸¥à¹ˆà¸™à¸„à¸™à¹€à¸”à¸µà¸¢à¸§ (à¸à¸±à¸šà¸„à¸­à¸¡à¸žà¸´à¸§à¹€à¸•à¸­à¸£à¹Œ)", two_players: "à¸ªà¸­à¸‡à¸„à¸™ (à¸—à¹‰à¸­à¸‡à¸–à¸´à¹ˆà¸™)",
        record_session: "à¸šà¸±à¸™à¸—à¸¶à¸à¹€à¸‹à¸ªà¸Šà¸±à¸™", start_recording: "à¹€à¸£à¸´à¹ˆà¸¡à¸šà¸±à¸™à¸—à¸¶à¸",
        stop_recording: "à¸«à¸¢à¸¸à¸”à¸šà¸±à¸™à¸—à¸¶à¸", press_to_record: "à¸à¸”à¸›à¸¸à¹ˆà¸¡à¹€à¸žà¸·à¹ˆà¸­à¹€à¸£à¸´à¹ˆà¸¡à¸šà¸±à¸™à¸—à¸¶à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸à¸²à¸£à¹€à¸„à¸¥à¸·à¹ˆà¸­à¸™à¹„à¸«à¸§",
        recording_in_progress: "à¸à¸³à¸¥à¸±à¸‡à¸šà¸±à¸™à¸—à¸¶à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸à¸²à¸£à¹€à¸„à¸¥à¸·à¹ˆà¸­à¸™à¹„à¸«à¸§...", recording_finished: "à¸šà¸±à¸™à¸—à¸¶à¸à¹€à¸ªà¸£à¹‡à¸ˆà¸ªà¸´à¹‰à¸™",
        export_data: "à¸ªà¹ˆà¸‡à¸­à¸­à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥", session_stats: "à¸ªà¸–à¸´à¸•à¸´à¹€à¸‹à¸ªà¸Šà¸±à¸™", movements: "à¸à¸²à¸£à¹€à¸„à¸¥à¸·à¹ˆà¸­à¸™à¹„à¸«à¸§",
        duration: "à¸£à¸°à¸¢à¸°à¹€à¸§à¸¥à¸²", play_history: "à¸›à¸£à¸°à¸§à¸±à¸•à¸´à¸à¸²à¸£à¹€à¸¥à¹ˆà¸™", clear_all: "à¸¥à¸šà¸›à¸£à¸°à¸§à¸±à¸•à¸´à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”",
        saved_sessions: "à¹€à¸‹à¸ªà¸Šà¸±à¸™à¸—à¸µà¹ˆà¸šà¸±à¸™à¸—à¸¶à¸à¹„à¸§à¹‰", no_history: "à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µà¸›à¸£à¸°à¸§à¸±à¸•à¸´à¸à¸²à¸£à¹€à¸¥à¹ˆà¸™",
        settings_title: "à¸à¸²à¸£à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸²", mediapipe_settings: "à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸² MediaPipe Hands",
        min_detection_confidence: "à¸„à¸§à¸²à¸¡à¸¡à¸±à¹ˆà¸™à¹ƒà¸ˆà¸‚à¸±à¹‰à¸™à¸•à¹ˆà¸³à¹ƒà¸™à¸à¸²à¸£à¸•à¸£à¸§à¸ˆà¸ˆà¸±à¸š:",
        min_tracking_confidence: "à¸„à¸§à¸²à¸¡à¸¡à¸±à¹ˆà¸™à¹ƒà¸ˆà¸‚à¸±à¹‰à¸™à¸•à¹ˆà¸³à¹ƒà¸™à¸à¸²à¸£à¸•à¸´à¸”à¸•à¸²à¸¡:",
        model_complexity: "à¸„à¸§à¸²à¸¡à¸‹à¸±à¸šà¸‹à¹‰à¸­à¸™à¸‚à¸­à¸‡à¹‚à¸¡à¹€à¸”à¸¥:", max_hands: "à¸ˆà¸³à¸™à¸§à¸™à¸¡à¸·à¸­à¸ªà¸¹à¸‡à¸ªà¸¸à¸”:",
        low: "à¸•à¹ˆà¸³", medium: "à¸›à¸²à¸™à¸à¸¥à¸²à¸‡", high: "à¸ªà¸¹à¸‡", one_hand: "1 à¸¡à¸·à¸­", two_hands: "2 à¸¡à¸·à¸­",
        save_settings: "à¸šà¸±à¸™à¸—à¸¶à¸à¸à¸²à¸£à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸²", data_recording_settings: "à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸²à¸à¸²à¸£à¸šà¸±à¸™à¸—à¸¶à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥",
        auto_record_prompt: "à¹à¸ˆà¹‰à¸‡à¹€à¸•à¸·à¸­à¸™à¹ƒà¸«à¹‰à¸šà¸±à¸™à¸—à¸¶à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸¡à¸·à¹ˆà¸­à¹€à¸£à¸´à¹ˆà¸¡à¹€à¸à¸¡",
        record_hand_data: "à¸šà¸±à¸™à¸—à¸¶à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸à¸²à¸£à¹€à¸„à¸¥à¸·à¹ˆà¸­à¸™à¹„à¸«à¸§à¸‚à¸­à¸‡à¸¡à¸·à¸­", record_game_data: "à¸šà¸±à¸™à¸—à¸¶à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸–à¸²à¸™à¸°à¹€à¸à¸¡",
        system_info: "à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸£à¸°à¸šà¸š", app_version: "à¹€à¸§à¸­à¸£à¹Œà¸Šà¸±à¸™à¹à¸­à¸›:",
        mediapipe_status: "MediaPipe Hands:", connection_status: "à¸à¸²à¸£à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­:",
        reset_settings: "à¸£à¸µà¹€à¸‹à¹‡à¸•à¸à¸²à¸£à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸²", player_won: "à¸œà¸¹à¹‰à¹€à¸¥à¹ˆà¸™ {player} à¸Šà¸™à¸°! ðŸŽ‰",
        draw: "à¹€à¸ªà¸¡à¸­! ðŸ¤", computer_turn: "à¸•à¸²à¸‚à¸­à¸‡à¸„à¸­à¸¡à¸žà¸´à¸§à¹€à¸•à¸­à¸£à¹Œ (O)...",
        player_turn: "à¸•à¸²à¸‚à¸­à¸‡à¸œà¸¹à¹‰à¹€à¸¥à¹ˆà¸™ {player}", camera_error: "à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¹€à¸‚à¹‰à¸²à¸–à¸¶à¸‡à¸à¸¥à¹‰à¸­à¸‡à¹„à¸”à¹‰ à¸à¸£à¸¸à¸“à¸²à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸à¸²à¸£à¸­à¸™à¸¸à¸à¸²à¸•à¹ƒà¸Šà¹‰à¸à¸¥à¹‰à¸­à¸‡",
        no_sessions: "à¹„à¸¡à¹ˆà¸¡à¸µà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸‹à¸ªà¸Šà¸±à¸™à¸—à¸µà¹ˆà¸ˆà¸°à¸ªà¹ˆà¸‡à¸­à¸­à¸", export_success: "à¸ªà¹ˆà¸‡à¸­à¸­à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢à¹à¸¥à¹‰à¸§",
        export_session_success: "à¸ªà¹ˆà¸‡à¸­à¸­à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸‹à¸ªà¸Šà¸±à¸™à¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢à¹à¸¥à¹‰à¸§",
        confirm_delete: "à¸„à¸¸à¸“à¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¸¥à¸šà¹€à¸‹à¸ªà¸Šà¸±à¸™à¸™à¸µà¹‰à¹ƒà¸Šà¹ˆà¹„à¸«à¸¡?",
        delete_success: "à¸¥à¸šà¹€à¸‹à¸ªà¸Šà¸±à¸™à¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢à¹à¸¥à¹‰à¸§",
        confirm_clear_all: "à¸„à¸¸à¸“à¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¸¥à¸šà¸›à¸£à¸°à¸§à¸±à¸•à¸´à¸à¸²à¸£à¹€à¸¥à¹ˆà¸™à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”à¹ƒà¸Šà¹ˆà¹„à¸«à¸¡?",
        clear_all_success: "à¸¥à¸šà¸›à¸£à¸°à¸§à¸±à¸•à¸´à¸à¸²à¸£à¹€à¸¥à¹ˆà¸™à¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢à¹à¸¥à¹‰à¸§",
        confirm_reset: "à¸„à¸¸à¸“à¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¸£à¸µà¹€à¸‹à¹‡à¸•à¸à¸²à¸£à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸²à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”à¹ƒà¸Šà¹ˆà¹„à¸«à¸¡?",
        reset_success: "à¸£à¸µà¹€à¸‹à¹‡à¸•à¸à¸²à¸£à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸²à¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢à¹à¸¥à¹‰à¸§", record_prompt: "à¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¸šà¸±à¸™à¸—à¸¶à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸à¸²à¸£à¹€à¸„à¸¥à¸·à¹ˆà¸­à¸™à¹„à¸«à¸§à¹ƒà¸™à¹€à¸‹à¸ªà¸Šà¸±à¸™à¸™à¸µà¹‰à¹„à¸«à¸¡?",
        settings_saved: "à¸šà¸±à¸™à¸—à¸¶à¸à¸à¸²à¸£à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸²à¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢à¹à¸¥à¹‰à¸§"
      }
    };

    let currentLang = 'en';

    function getText(key, params = {}) {
      let text = translations[currentLang][key] || translations['en'][key] || key;
      Object.keys(params).forEach(param => {
        text = text.replace(`{${param}}`, params[param]);
      });
      return text;
    }

    function updateTexts() {
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        const text = getText(key);
        if (el.tagName === 'INPUT' && el.hasAttribute('placeholder')) {
          el.placeholder = text;
        } else if (el.tagName === 'OPTION') {
          el.textContent = text;
        } else {
          el.textContent = text;
        }
      });
      
      // Update dynamic texts
      document.getElementById('lang-text').textContent = currentLang.toUpperCase();
      document.title = getText('app_title');
    }

    function toggleLanguage() {
      currentLang = currentLang === 'en' ? 'th' : 'en';
      localStorage.setItem('language', currentLang);
      updateTexts();
      document.documentElement.lang = currentLang;
      updateCameraButtonText();
    }

    function applyStoredLang() {
      const savedLang = localStorage.getItem('language');
      if (savedLang) {
        currentLang = savedLang;
        document.documentElement.lang = currentLang;
      }
      updateTexts();
    }

    function updateCameraButtonText() {
      const cameraText = document.getElementById('camera-text');
      if (cameraText) {
        cameraText.textContent = getText(cameraOn ? 'camera_off' : 'camera_on');
      }
    }

    // ================= PAGE MANAGEMENT =================
    document.addEventListener("DOMContentLoaded", () => {
        initializeApp();
        initializeGame();
        loadSettings();
        updateStats();
        applyStoredLang();
    });

    function initializeApp() {
        // document.querySelectorAll(".menu-item").forEach((item) => {
        //     item.addEventListener("click", (e) => {
        //         e.preventDefault();
        //         changePage(item.getAttribute("data-page"));
        //     });
        // });
        changePage("home");
    }

    function changePage(pageId) {
        document.querySelectorAll(".page").forEach((page) =>
            page.classList.remove("active")
        );
        document.getElementById(pageId).classList.add("active");

        document.querySelectorAll(".menu-item").forEach((item) => {
            item.classList.remove("active");
            if (item.getAttribute("data-page") === pageId) item.classList.add("active");
        });

        if (pageId === "tictactoe") {
            initializeTicTacToe();
            if (document.getElementById("autoRecord") && document.getElementById("autoRecord").checked) {
                showRecordPrompt();
            }
        } else if (pageId === "replay") {
            loadReplaySessions();
        } else if (pageId === "settings") {
            loadSettings();
        } else {
            resetGameState();
        }
    }

    // HandCursorController Class
    class HandCursorController {
        constructor(container, video, cursor) {
            this.container = container;
            this.video = video;
            this.cursor = cursor;
            this.canvas = document.getElementById('overlay');
            this.ctx = this.canvas.getContext('2d');
            this.smoothFactor = 0.5;
            this.lastX = null;
            this.lastY = null;
            this.currentLandmarks = null;

            this.hands = new Hands({
                locateFile: (file) => {
                    return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
                }
            });

            this.updateSettings();
            this.hands.onResults(this.onResults.bind(this));

            this.camera = new Camera(this.video, {
                onFrame: async () => {
                    await this.hands.send({ image: this.video });
                },
                width: 640,
                height: 480
            });

            this.resizeCanvas();
            window.addEventListener('resize', () => this.resizeCanvas());
        }

        resizeCanvas() {
            if (this.canvas && this.container) {
                this.canvas.width = this.container.clientWidth;
                this.canvas.height = this.container.clientHeight;
            }
        }

        updateSettings() {
            const settings = JSON.parse(localStorage.getItem('mediapipeSettings')) || {
                minDetectionConfidence: 0.7,
                minTrackingConfidence: 0.7,
                modelComplexity: 1,
                maxNumHands: 1
            };

            this.hands.setOptions({
                maxNumHands: settings.maxNumHands,
                modelComplexity: settings.modelComplexity,
                minDetectionConfidence: settings.minDetectionConfidence,
                minTrackingConfidence: settings.minTrackingConfidence
            });
        }

        async start() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                this.camera.start();
                cameraOn = true;
                document.getElementById('toggleBtn').innerHTML = '<i class="fas fa-video-slash"></i> ' + getText('camera_off');
            } catch (error) {
                console.error("Error accessing camera:", error);
                alert(getText('camera_error'));
            }
        }

        stop() {
            try {
                if (this.camera) {
                    this.camera.stop();
                }
                cameraOn = false;
                document.getElementById('toggleBtn').innerHTML = '<i class="fas fa-video"></i> ' + getText('camera_on');
                console.log("Camera stopped");
            } catch (error) {
                console.error("Error stopping camera:", error);
            }
        }

        setSmooth(f) {
            this.smoothFactor = f;
        }

        getCurrentHandData() {
            return this.currentLandmarks;
        }

        onResults(results) {
            if (!this.ctx || !this.canvas || !this.cursor) return;

            this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
            this.currentLandmarks = results.multiHandLandmarks;

            if (results.multiHandLandmarks) {
                for (const landmarks of results.multiHandLandmarks) {
                    this.drawLandmarks(landmarks);
                }
            }

            if (!results.multiHandLandmarks || results.multiHandLandmarks.length === 0) {
                this.cursor.style.display = 'none';
                return;
            }

            this.cursor.style.display = 'none';
            const board = document.getElementById("board");
            const boardRect = board.getBoundingClientRect();
            const lm = results.multiHandLandmarks[0];
            let x = (1 - lm[8].x) * boardRect.width + boardRect.left;
            let y = lm[8].y * boardRect.height + boardRect.top;

            if (this.lastX !== null) {
                x = this.lastX + (x - this.lastX) * (1 - this.smoothFactor);
                y = this.lastY + (y - this.lastY) * (1 - this.smoothFactor);
            }

            this.lastX = x;
            this.lastY = y;
            this.cursor.style.left = x + "px";
            this.cursor.style.top = y + "px";

            if (this.container) {
                this.container.dispatchEvent(new CustomEvent("cursor-move", { detail: { x, y } }));
            }

            const dx = (lm[4].x - lm[8].x) * this.container.clientWidth;
            const dy = (lm[4].y - lm[8].y) * this.container.clientHeight;
            const dist = Math.sqrt(dx * dx + dy * dy);

            if (dist < 40) {
                this.cursor.style.background = "rgba(0,255,0,0.7)";
                if (this.container) {
                    this.container.dispatchEvent(new CustomEvent("cursor-click", { detail: { x, y } }));
                }
            } else {
                this.cursor.style.background = "rgba(255,255,255,0.7)";
            }
        }

        drawLandmarks(landmarks) {
            if (!this.ctx || !this.canvas) return;

            this.ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
            this.ctx.strokeStyle = 'rgba(255, 255, 255, 0.8)';
            this.ctx.lineWidth = 2;

            for (const landmark of landmarks) {
                const x = (1 - landmark.x) * this.canvas.width;
                const y = landmark.y * this.canvas.height;
                this.ctx.beginPath();
                this.ctx.arc(x, y, 4, 0, 2 * Math.PI);
                this.ctx.fill();
            }

            const connections = [
                [0, 1, 2, 3, 4],
                [0, 5, 6, 7, 8],
                [0, 9, 10, 11, 12],
                [0, 13, 14, 15, 16],
                [0, 17, 18, 19, 20],
                [5, 9, 13, 17, 0]
            ];

            for (const connection of connections) {
                this.ctx.beginPath();
                for (let i = 0; i < connection.length - 1; i++) {
                    const start = landmarks[connection[i]];
                    const end = landmarks[connection[i + 1]];
                    const startX = (1 - start.x) * this.canvas.width;
                    const startY = start.y * this.canvas.height;
                    const endX = (1 - end.x) * this.canvas.width;
                    const endY = end.y * this.canvas.height;

                    if (i === 0) {
                        this.ctx.moveTo(startX, startY);
                    }
                    this.ctx.lineTo(endX, endY);
                }
                this.ctx.stroke();
            }
        }
    }

    // GameXO Class
    class GameXO {
        constructor(container) {
            this.container = container;
            this.board = container.querySelector("#board");
            this.cells = Array.from(this.board.querySelectorAll(".cell"));
            this.state = Array(9).fill(null);
            this.currentPlayer = "X";
            this.gameActive = true;
            this.isRecording = false;
            this.recordedMoves = [];
            this.recordedHandData = [];
            this.moveCount = 0;
            this.gameStatusEl = document.getElementById("gameStatus");
            this.isComputerThinking = false;

            if (this.container) {
                this.container.addEventListener("cursor-click", (e) => {
                    this.handleClick(e.detail.x, e.detail.y);
                });
            }

            this.cells.forEach((cell, index) =>
                cell.addEventListener("click", () => this.handleCellClick(index))
            );
        }

handleClick(x, y) {
    const boardRect = this.board.getBoundingClientRect();
    const relX = x - boardRect.left;
    const relY = y - boardRect.top;

    const col = Math.floor(relX / (boardRect.width / 3));
    const row = Math.floor(relY / (boardRect.height / 3));

    if (col >= 0 && col < 3 && row >= 0 && row < 3) {
        const index = row * 3 + col;
        this.handleCellClick(index);
    }
}


        getCellIndexFromPosition(x, y) {
            if (!this.board) return -1;

            const rect = this.board.getBoundingClientRect();
            const col = Math.floor((x - rect.left) / (rect.width / 3));
            const row = Math.floor((y - rect.top) / (rect.height / 3));
            if (col < 0 || col > 2 || row < 0 || row > 2) return -1;
            console.log(row,',',row*3,',',col)
            return row * 3 + col;
        }

        handleCellClick(index) {
            if (!this.gameActive || this.state[index] || this.isComputerThinking) return;

            if (this.getGameMode() === "single") {
                if (this.currentPlayer !== "X") return;
            }

            this.playMove(index);

            const result = this.checkGameStatus();

            if (!result && this.gameActive && this.getGameMode() === "single" && this.currentPlayer === "O") {
                this.isComputerThinking = true;
                setTimeout(() => {
                    this.computerMove();
                    this.checkGameStatus();
                    this.isComputerThinking = false;
                }, 600);
            }
        }

        playMove(index) {
            this.state[index] = this.currentPlayer;
            this.cells[index].textContent = this.currentPlayer;
            this.cells[index].classList.add(this.currentPlayer === "X" ? "x-mark" : "o-mark");
            this.moveCount++;

            if (this.isRecording) {
                this.recordMove(index, controller ? controller.getCurrentHandData() : null);
            }
        }

        getGameMode() {
            const gameModeElement = document.getElementById("gameMode");
            return gameModeElement ? gameModeElement.value : "single";
        }

        computerMove() {
            if (!this.gameActive) return;

            const availableCells = this.state
                .map((cell, idx) => (cell === null ? idx : null))
                .filter((idx) => idx !== null);

            if (availableCells.length === 0) return;

            const randomIndex = availableCells[Math.floor(Math.random() * availableCells.length)];
            this.playMove(randomIndex);
        }

        recordMove(index, handData) {
            this.recordedMoves.push({
                index,
                player: this.currentPlayer,
                timestamp: Date.now(),
                handData,
                gameState: [...this.state],
                cursorPosition: this.getCursorPosition(),
            });
            updateSessionStats(this.recordedMoves.length, sessionStartTime);
        }

        getCursorPosition() {
            const cursor = document.getElementById("cursorSim");
            if (cursor && cursor.style.display !== "none") {
                return { x: parseInt(cursor.style.left) || 0, y: parseInt(cursor.style.top) || 0 };
            }
            return { x: 0, y: 0 };
        }

        checkGameStatus() {
            const winPatterns = [
                [0, 1, 2], [3, 4, 5], [6, 7, 8],
                [0, 3, 6], [1, 4, 7], [2, 5, 8],
                [0, 4, 8], [2, 4, 6]
            ];

            for (let [a, b, c] of winPatterns) {
                if (this.state[a] && this.state[a] === this.state[b] && this.state[a] === this.state[c]) {
                    this.gameActive = false;
                    this.gameStatusEl.textContent = getText('player_won', {player: this.state[a]});

                    if (this.isRecording) {
                        this.saveGameSession(this.state[a]);
                    }

                    return this.state[a];
                }
            }

            if (!this.state.includes(null)) {
                this.gameActive = false;
                this.gameStatusEl.textContent = getText('draw');

                if (this.isRecording) {
                    this.saveGameSession("draw");
                }

                return "draw";
            }

            this.currentPlayer = this.currentPlayer === "X" ? "O" : "X";

            if (this.getGameMode() === "single" && this.currentPlayer === "O") {
                this.gameStatusEl.textContent = getText('computer_turn');
            } else {
                this.gameStatusEl.textContent = getText('player_turn', {player: this.currentPlayer});
            }

            return null;
        }

        reset() {
            this.state.fill(null);
            this.currentPlayer = "X";
            this.gameActive = true;
            this.isComputerThinking = false;
            this.moveCount = 0;
            this.cells.forEach((cell) => {
                cell.textContent = "";
                cell.classList.remove("x-mark", "o-mark");
            });
            if (this.gameStatusEl) {
                this.gameStatusEl.textContent = getText('player_x_turn');
            }
            this.recordedMoves = [];
            this.recordedHandData = [];
            updateSessionStats(0, Date.now());
        }

        saveGameSession(result) {
            const session = {
                game: 'Tic Tac Toe',
                timestamp: Date.now(),
                duration: Date.now() - sessionStartTime,
                result: result,
                moves: this.recordedMoves,
                handData: this.recordedHandData,
                gameState: this.state
            };

            const sessions = JSON.parse(localStorage.getItem('therapySessions')) || [];
            sessions.push(session);
            localStorage.setItem('therapySessions', JSON.stringify(sessions));

            updateStats();
        }
    }

    function resetGameState() {
        if (isRecording) stopRecording();
        if (controller && cameraOn) controller.stop();
        if (gameOX) gameOX.reset();
        if (replayCanvas) {
            replayCanvas.remove();
            replayCanvas = null;
        }
    }

    function startHandRecording() {
        if (recordingInterval) clearInterval(recordingInterval);

        recordingInterval = setInterval(() => {
            if (controller && gameOX && gameOX.isRecording) {
                const handData = controller.getCurrentHandData();
                const cursorPos = gameOX.getCursorPosition();

                if (handData) {
                    gameOX.recordedHandData.push({
                        timestamp: Date.now(),
                        handLandmarks: handData,
                        cursorPosition: cursorPos
                    });

                    updateSessionStats(gameOX.recordedMoves.length, sessionStartTime);
                }
            }
        }, 100);
    }

    function initializeGame() {
        const gameContainer = document.getElementById("gameContainer");
        const video = document.getElementById("video");
        const cursor = document.getElementById("cursorSim");

        if (gameContainer && video && cursor) {
            controller = new HandCursorController(gameContainer, video, cursor);
            gameOX = new GameXO(gameContainer);

            const smoothRange = document.getElementById("smoothRange");
            if (smoothRange) {
                smoothRange.addEventListener("input", (e) =>
                    controller.setSmooth(parseFloat(e.target.value))
                );
            }
        }
    }

    function initializeTicTacToe() {
        if (gameOX) gameOX.reset();
    }

    function toggleVideo() {
        if (controller) {
            if (cameraOn) {
                controller.stop();
            } else {
                controller.start();
            }
            // updateCameraButtonText();
        }
    }

    function restartGame() {
        if (gameOX) {
            gameOX.reset();
        }

        updateSessionStats(0, Date.now());
    }

    function toggleRecording() {
        if (isRecording) {
            stopRecording();
        } else {
            startRecording();
        }
    }

    function startRecording() {
        isRecording = true;
        sessionStartTime = Date.now();
        if (gameOX) {
            gameOX.isRecording = true;
            gameOX.recordedHandData = [];
        }

        const recordText = document.getElementById('recordText');
        const recordingStatus = document.getElementById('recordingStatus');
        const recordBtn = document.getElementById('recordBtn');
        const exportBtn = document.getElementById('exportBtn');

        if (recordText) recordText.textContent = getText('stop_recording');
        if (recordingStatus) recordingStatus.textContent = getText('recording_in_progress');
        if (recordBtn) recordBtn.classList.add('recording');
        if (exportBtn) exportBtn.style.display = 'none';

        startHandRecording();

        updateSessionStats(0, sessionStartTime);
    }

    function stopRecording() {
        isRecording = false;
        if (recordingInterval) {
            clearInterval(recordingInterval);
            recordingInterval = null;
        }

        if (gameOX) {
            gameOX.isRecording = false;

            if (gameOX.recordedMoves.length > 0 || gameOX.recordedHandData.length > 0) {
                const result = gameOX.checkGameStatus() || "incomplete";
                gameOX.saveGameSession(result);
            }
        }

        const recordText = document.getElementById('recordText');
        const recordingStatus = document.getElementById('recordingStatus');
        const recordBtn = document.getElementById('recordBtn');
        const exportBtn = document.getElementById('exportBtn');

        if (recordText) recordText.textContent = getText('start_recording');
        if (recordingStatus) recordingStatus.textContent = getText('recording_finished');
        if (recordBtn) recordBtn.classList.remove('recording');
        if (exportBtn) showExportButton();
    }

    function showExportButton() {
        const exportBtn = document.getElementById('exportBtn');
        if (exportBtn) {
            exportBtn.style.display = 'block';
        }
    }

    function updateSessionStats(moveCount, startTime) {
        const moveCountElement = document.getElementById('moveCount');
        const sessionTimeElement = document.getElementById('sessionTime');

        if (moveCountElement) moveCountElement.textContent = moveCount;

        if (startTime && sessionTimeElement) {
            const duration = Math.floor((Date.now() - startTime) / 1000);
            sessionTimeElement.textContent = duration + 's';
        }
    }

    function exportSession() {
        const sessions = JSON.parse(localStorage.getItem('therapySessions')) || [];
        if (sessions.length === 0) {
            alert(getText('no_sessions'));
            return;
        }

        const exportData = {
            exportDate: new Date().toISOString(),
            patientInfo: {
                name: "Unspecified",
                age: "Unspecified",
                condition: "Unspecified"
            },
            sessions: sessions
        };

        const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `therapy-sessions-${Date.now()}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        alert(getText('export_success'));
    }

    function loadReplaySessions() {
        const sessions = JSON.parse(localStorage.getItem('therapySessions')) || [];
        const replayList = document.getElementById('replayList');

        if (!replayList) return;

        if (sessions.length === 0) {
            replayList.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-history fa-3x"></i>
                    <p data-i18n="no_history">No play history yet</p>
                </div>
            `;
            return;
        }

        replayList.innerHTML = '';
        sessions.reverse().forEach((session, index) => {
            const actualIndex = sessions.length - 1 - index;
            const sessionElement = document.createElement('div');
            sessionElement.className = 'replay-item';
            sessionElement.innerHTML = `
                <div class="replay-header">
                    <h4>${session.game} Session</h4>
                    <span class="replay-date">${new Date(session.timestamp).toLocaleDateString(currentLang === 'th' ? 'th-TH' : 'en-US')}</span>
                </div>
                <div class="replay-details">
                    <p>${getText('result')}: ${getResultText(session.result)}</p>
                    <p>${getText('movements')}: ${session.moves.length}</p>
                    <p>${getText('duration')}: ${Math.round(session.duration / 1000)}s</p>
                    <p>${getText('hand_data')}: ${session.handData ? session.handData.length + ' frames' : 'None'}</p>
                </div>
                <div class="replay-actions">
                    <button class="btn-primary" onclick="viewReplay(${actualIndex})">
                        <i class="fas fa-play"></i> ${getText('view_replay')}
                    </button>
                    <button class="btn-secondary" onclick="exportSingleSession(${actualIndex})">
                        <i class="fas fa-download"></i> ${getText('export_data')}
                    </button>
                    <button class="btn-danger" onclick="deleteSession(${actualIndex})">
                        <i class="fas fa-trash"></i> ${getText('delete')}
                    </button>
                </div>
            `;
            replayList.appendChild(sessionElement);
        });
    }

    function getResultText(result) {
        switch (result) {
            case 'X': return 'X ' + getText('wins');
            case 'O': return 'O ' + getText('wins');
            case 'draw': return getText('draw');
            default: return getText('incomplete');
        }
    }

    function viewReplay(sessionIndex) {
        const sessions = JSON.parse(localStorage.getItem('therapySessions')) || [];
        const session = sessions[sessionIndex];

        if (!session) return;

        changePage('tictactoe');
        setTimeout(() => playReplay(session), 500);
    }

    function playReplay(session) {
        if (!gameOX) return;

        gameOX.reset();
        gameOX.gameActive = false;

        const gameStatusEl = document.getElementById('gameStatus');
        if (gameStatusEl) {
            gameStatusEl.textContent = `Replay: ${getResultText(session.result)}`;
        }

        if (replayCanvas) {
            replayCanvas.remove();
        }

        replayCanvas = document.createElement('canvas');
        const overlayCanvas = document.getElementById('overlay');
        if (overlayCanvas) {
            replayCanvas.width = overlayCanvas.width;
            replayCanvas.height = overlayCanvas.height;
        }
        replayCanvas.style.position = 'absolute';
        replayCanvas.style.top = '0';
        replayCanvas.style.left = '0';
        replayCanvas.style.zIndex = '2';

        const gameContainer = document.getElementById('gameContainer');
        if (gameContainer) {
            gameContainer.appendChild(replayCanvas);
        }

        const ctx = replayCanvas.getContext('2d');

        let moveIndex = 0;
        let handDataIndex = 0;
        let replayInterval;

        function playNextMove() {
            if (moveIndex >= session.moves.length && handDataIndex >= session.handData.length) {
                clearInterval(replayInterval);
                if (gameStatusEl) {
                    gameStatusEl.textContent = `Replay Complete: ${getResultText(session.result)}`;
                }
                return;
            }

            if (session.handData && handDataIndex < session.handData.length) {
                const handFrame = session.handData[handDataIndex];
                drawHandReplay(ctx, handFrame.handLandmarks, handFrame.cursorPosition);
                handDataIndex++;
            }

            if (moveIndex < session.moves.length) {
                const move = session.moves[moveIndex];
                gameOX.state[move.index] = move.player;
                gameOX.cells[move.index].textContent = move.player;
                gameOX.cells[move.index].classList.add(move.player === 'X' ? 'x-mark' : 'o-mark');
                moveIndex++;
            }
        }

        function drawHandReplay(context, landmarks, cursorPos) {
            if (!context) return;

            context.clearRect(0, 0, context.canvas.width, context.canvas.height);

            if (!landmarks) return;

            context.fillStyle = 'rgba(255, 255, 255, 0.5)';
            context.strokeStyle = 'rgba(255, 255, 255, 0.8)';
            context.lineWidth = 2;

            for (const hand of landmarks) {
                for (const landmark of hand) {
                    const x = (1 - landmark.x) * context.canvas.width;
                    const y = landmark.y * context.canvas.height;
                    context.beginPath();
                    context.arc(x, y, 4, 0, 2 * Math.PI);
                    context.fill();
                }

                const connections = [
                    [0, 1, 2, 3, 4],
                    [0, 5, 6, 7, 8],
                    [0, 9, 10, 11, 12],
                    [0, 13, 14, 15, 16],
                    [0, 17, 18, 19, 20],
                    [5, 9, 13, 17, 0]
                ];

                for (const connection of connections) {
                    context.beginPath();
                    for (let i = 0; i < connection.length - 1; i++) {
                        const start = hand[connection[i]];
                        const end = hand[connection[i + 1]];
                        const startX = (1 - start.x) * context.canvas.width;
                        const startY = start.y * context.canvas.height;
                        const endX = (1 - end.x) * context.canvas.width;
                        const endY = end.y * context.canvas.height;

                        if (i === 0) {
                            context.moveTo(startX, startY);
                        }
                        context.lineTo(endX, endY);
                    }
                    context.stroke();
                }
            }

            if (cursorPos && cursorPos.x > 0 && cursorPos.y > 0) {
                context.fillStyle = 'rgba(77, 227, 194, 0.9)';
                context.beginPath();
                context.arc(cursorPos.x, cursorPos.y, 14, 0, 2 * Math.PI);
                context.fill();
            }
        }

        replayInterval = setInterval(playNextMove, 200);
    }

    function exportSingleSession(sessionIndex) {
        const sessions = JSON.parse(localStorage.getItem('therapySessions')) || [];
        const session = sessions[sessionIndex];

        if (!session) return;

        const exportData = {
            exportDate: new Date().toISOString(),
            session: session
        };

        const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `therapy-session-${sessionIndex}-${Date.now()}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        alert(getText('export_session_success'));
    }

    function deleteSession(sessionIndex) {
        const sessions = JSON.parse(localStorage.getItem('therapySessions')) || [];

        if (sessionIndex >= 0 && sessionIndex < sessions.length) {
            if (confirm(getText('confirm_delete'))) {
                sessions.splice(sessionIndex, 1);
                localStorage.setItem('therapySessions', JSON.stringify(sessions));
                loadReplaySessions();
                updateStats();
                alert(getText('delete_success'));
            }
        }
    }

    function clearAllSessions() {
        if (confirm(getText('confirm_clear_all'))) {
            localStorage.removeItem('therapySessions');
            loadReplaySessions();
            updateStats();
            alert(getText('clear_all_success'));
        }
    }

    function loadSettings() {
        const settings = JSON.parse(localStorage.getItem('mediapipeSettings')) || {
            minDetectionConfidence: 0.7,
            minTrackingConfidence: 0.7,
            modelComplexity: 1,
            maxNumHands: 1
        };

        const minDetectionConfidence = document.getElementById('minDetectionConfidence');
        const minTrackingConfidence = document.getElementById('minTrackingConfidence');
        const modelComplexity = document.getElementById('modelComplexity');
        const maxNumHands = document.getElementById('maxNumHands');
        const minDetectionConfidenceValue = document.getElementById('minDetectionConfidenceValue');
        const minTrackingConfidenceValue = document.getElementById('minTrackingConfidenceValue');

        if (minDetectionConfidence) minDetectionConfidence.value = settings.minDetectionConfidence;
        if (minTrackingConfidence) minTrackingConfidence.value = settings.minTrackingConfidence;
        if (modelComplexity) modelComplexity.value = settings.modelComplexity;
        if (maxNumHands) maxNumHands.value = settings.maxNumHands;
        if (minDetectionConfidenceValue) minDetectionConfidenceValue.textContent = settings.minDetectionConfidence;
        if (minTrackingConfidenceValue) minTrackingConfidenceValue.textContent = settings.minTrackingConfidence;

        const recordSettings = JSON.parse(localStorage.getItem('recordSettings')) || {
            autoRecord: false,
            recordHandData: true,
            recordGameData: true
        };

        const autoRecord = document.getElementById('autoRecord');
        const recordHandData = document.getElementById('recordHandData');
        const recordGameData = document.getElementById('recordGameData');

        if (autoRecord) autoRecord.checked = recordSettings.autoRecord;
        if (recordHandData) recordHandData.checked = recordSettings.recordHandData;
        if (recordGameData) recordGameData.checked = recordSettings.recordGameData;
    }

    function saveMediaPipeSettings() {
        const minDetectionConfidence = document.getElementById('minDetectionConfidence');
        const minTrackingConfidence = document.getElementById('minTrackingConfidence');
        const modelComplexity = document.getElementById('modelComplexity');
        const maxNumHands = document.getElementById('maxNumHands');

        if (!minDetectionConfidence || !minTrackingConfidence || !modelComplexity || !maxNumHands) return;

        const settings = {
            minDetectionConfidence: parseFloat(minDetectionConfidence.value),
            minTrackingConfidence: parseFloat(minTrackingConfidence.value),
            modelComplexity: parseInt(modelComplexity.value),
            maxNumHands: parseInt(maxNumHands.value)
        };

        localStorage.setItem('mediapipeSettings', JSON.stringify(settings));

        const autoRecord = document.getElementById('autoRecord');
        const recordHandData = document.getElementById('recordHandData');
        const recordGameData = document.getElementById('recordGameData');

        const recordSettings = {
            autoRecord: autoRecord ? autoRecord.checked : false,
            recordHandData: recordHandData ? recordHandData.checked : true,
            recordGameData: recordGameData ? recordGameData.checked : true
        };

        localStorage.setItem('recordSettings', JSON.stringify(recordSettings));

        if (controller) {
            controller.updateSettings();
        }

        alert(getText('settings_saved'));
    }

    function resetAppSettings() {
        if (confirm(getText('confirm_reset'))) {
            localStorage.removeItem('mediapipeSettings');
            localStorage.removeItem('recordSettings');
            loadSettings();
            alert(getText('reset_success'));
        }
    }

    function showRecordPrompt() {
        if (confirm(getText('record_prompt'))) {
            startRecording();
        }
    }

    function updateStats() {
        const sessions = JSON.parse(localStorage.getItem('therapySessions')) || [];
        let totalPlayTime = 0;

        sessions.forEach(session => {
            totalPlayTime += session.duration || 0;
        });

        const sessionCountElement = document.getElementById('sessionCount');
        const totalPlayTimeElement = document.getElementById('totalPlayTime');

        if (sessionCountElement) sessionCountElement.textContent = sessions.length;
        if (totalPlayTimeElement) totalPlayTimeElement.textContent = Math.round(totalPlayTime / 60000);
    }

    updateStats();
  </script>
</body>
</html>